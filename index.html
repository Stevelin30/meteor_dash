<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Meteor Dash ‚Äî Safe Boot</title>
<style>
  :root{ --bg:#0b1020; --fg:#e2e8f0; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui; }
  #wrap{ position:fixed; inset:0; display:flex; flex-direction:column; }
  header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.08); }
  .controls,.right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  button{ cursor:pointer; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--fg); font-weight:700; }
  #canvas{ flex:1 1 auto; width:100%; height:100%; display:block; background: #0b1020; }
  footer{ display:flex; justify-content:center; padding:8px; font-size:12px; opacity:.9; gap:12px; flex-wrap:wrap; }
  #shipSelect{ display:flex; gap:8px; }
  .ship-option{ width:28px; height:28px; border-radius:6px; cursor:pointer; border:2px solid transparent; }
  .ship-option.selected{ border-color:white; }
  #difficultySelect{ display:flex; gap:6px; }
  .difficulty-btn{ padding:4px 8px; border-radius:6px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:white; font-weight:700; }
  .volwrap{ display:flex; align-items:center; gap:6px; }
  #musicVolume{ width:100px; }
  /* Error overlay */
  #err{ position:fixed; left:12px; right:12px; bottom:12px; z-index:9999;
        background:#7f1d1d; color:#fff; padding:12px; border:2px solid #fecaca; border-radius:10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; display:none; white-space:pre-wrap }
  #infobar{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
  #infobar .card{ pointer-events:auto; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); padding:20px; border-radius:14px; text-align:center }
  #bigStart{ font-size:18px; margin-top:12px }
</style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="controls">
      <span id="scoreLabel">Score: 0</span>
      <span id="hiLabel">Best: 0</span>
      <button id="btnStart">Start</button>
      <button id="btnPause" disabled>Pause</button>
      <button id="btnMute" aria-pressed="false">üîä</button>
      <div class="volwrap">
        <input id="musicVolume" type="range" min="0" max="1" step="0.05" value="0.4">
        <span id="volLabel" style="display:inline-block; width:34px; text-align:right;">40%</span>
      </div>
    </div>
    <div class="right">
      <div id="shipSelect" title="Pick a ship"></div>
      <div id="difficultySelect" title="Difficulty"></div>
    </div>
  </header>

  <canvas id="canvas"></canvas>

  <footer>
    <span>Move: ‚Üê ‚Üí or A/D</span>
    <span>Pause: P ¬∑ Restart: R</span>
    <span>Tip: Grab 2 power-ups quickly for a <b>Comedy Combo</b>!</span>
  </footer>
</div>

<!-- Local background music (put music.mp3 next to this file). Optional. -->
<audio id="bgMusic" loop preload="auto">
  <source src="music.mp3" type="audio/mpeg">
</audio>

<!-- Error overlay + big Start prompt -->
<div id="infobar"><div class="card">
  <div style="font-size:28px; font-weight:800; margin-bottom:6px">Meteor Dash</div>
  <div>Pick a ship & difficulty, then press Start</div>
  <button id="bigStart" class="start">Start</button>
</div></div>
<div id="err"></div>

<script>
(function(){
  // ====== DEBUG SAFEGUARDS ======
  const errBox = document.getElementById('err');
  function showErr(msg){
    errBox.style.display='block';
    errBox.textContent = msg;
    console.error(msg);
  }
  window.onerror = function(message, source, lineno, colno, error){
    showErr("JS Error: " + message + "\n" + source + ":" + lineno + ":" + colno + (error && error.stack ? "\n" + error.stack : ""));
  };
  window.addEventListener('unhandledrejection', (e)=> showErr("Promise rejection: " + e.reason));

  // ====== SETUP ======
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  let W=0, H=0;
  function resize(){
    try{
      const hH = document.querySelector('header').offsetHeight || 0;
      const fH = document.querySelector('footer').offsetHeight || 0;
      W = Math.floor(window.innerWidth);
      H = Math.floor(window.innerHeight - hH - fH);
      if(H < 120) H = 120; // avoid zero height
      canvas.width = Math.floor(W*DPR);
      canvas.height = Math.floor(H*DPR);
      canvas.style.width = W+'px';
      canvas.style.height = H+'px';
      ctx.setTransform(DPR,0,0,DPR,0,0);
      drawStart(); // always render something on resize
    }catch(e){ showErr("Resize failed: " + e); }
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  // ====== UI ======
  const elScore = document.getElementById('scoreLabel');
  const elHi = document.getElementById('hiLabel');
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnMute = document.getElementById('btnMute');
  const volSlider = document.getElementById('musicVolume');
  const volLabel = document.getElementById('volLabel');
  const shipSelect = document.getElementById('shipSelect');
  const difficultySelect = document.getElementById('difficultySelect');
  const bigStart = document.getElementById('bigStart');
  const infobar = document.getElementById('infobar');

  let hi = 0;
  try { hi = Number(localStorage.getItem('meteorDash_hi') || 0); } catch(_) {}
  elHi.textContent = `Best: ${hi}`;

  // ====== Audio ======
  const bgMusic = document.getElementById('bgMusic');
  let masterVolume = parseFloat(volSlider.value) || 0.4;
  let muted = false;
  function setVolume(v){
    masterVolume = Math.max(0, Math.min(1, v));
    if (bgMusic) bgMusic.volume = masterVolume;
    volSlider.value = String(masterVolume);
    volLabel.textContent = Math.round(masterVolume*100) + '%';
  }
  setVolume(masterVolume);
  volSlider.addEventListener('input', e => setVolume(parseFloat(e.target.value)||masterVolume));

  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ac = null;
  function ensureAudio(){ if(!ac) ac = new AudioCtx(); }
  function tone(freq=880, dur=0.09, type='sine', vol=0.05){
    if(muted) return;
    try{
      ensureAudio();
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = vol * masterVolume;
      o.connect(g); g.connect(ac.destination);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + dur);
      o.stop(ac.currentTime + dur);
    }catch(e){ showErr("Audio error: " + e); }
  }
  async function tryPlayMusic(){
    if(!bgMusic) return;
    try { await bgMusic.play(); }
    catch(e){ /* browsers may block autoplay; user clicking Start will allow */ }
  }
  btnMute.addEventListener('click', ()=>{
    muted = !muted;
    btnMute.textContent = muted ? 'üîá' : 'üîä';
    btnMute.setAttribute('aria-pressed', String(muted));
    if(bgMusic){ if(muted) bgMusic.pause(); else tryPlayMusic(); }
  });

  // ====== Ships & Difficulty (simple, safe) ======
  const ships = [
    {name:'Red',   color1:'#f87171', color2:'#ef4444'},
    {name:'Blue',  color1:'#60a5fa', color2:'#2563eb'},
    {name:'Green', color1:'#34d399', color2:'#059669'},
    {name:'Purple',color1:'#c084fc', color2:'#7c3aed'}
  ];
  let selectedShip = ships[0];
  ships.forEach((s,i)=>{
    const div = document.createElement('div');
    div.className = 'ship-option'+(i===0?' selected':'');
    div.style.background = `linear-gradient(${s.color1},${s.color2})`;
    div.title = s.name;
    div.addEventListener('click', ()=>{
      document.querySelectorAll('.ship-option').forEach(el=>el.classList.remove('selected'));
      div.classList.add('selected'); selectedShip=s; drawStart();
    });
    shipSelect.appendChild(div);
  });

  const difficulties = [
    {name:'Easy',   speed:1.6, spawn:520, coin:650, multiplier:1.0, starDensity:0.18, palette:['#0b1020','#0e1633'], parallax:[0.1,0.25,0.5]},
    {name:'Normal', speed:2.3, spawn:400, coin:900, multiplier:1.0, starDensity:0.22, palette:['#0b1020','#12183b'], parallax:[0.15,0.35,0.7]},
    {name:'Hard',   speed:3.1, spawn:300, coin:1250, multiplier:1.2, starDensity:0.26, palette:['#0a0c24','#15183f'], parallax:[0.2,0.5,0.9]},
    {name:'Insane', speed:4.2, spawn:200, coin:2100, multiplier:1.5, starDensity:0.32, palette:['#120a20','#2a0e3c'], parallax:[0.28,0.7,1.2]},
  ];
  let selectedDifficulty = difficulties[1];
  difficulties.forEach((d,i)=>{
    const btn = document.createElement('button');
    btn.className='difficulty-btn'+(i===1?' selected':'');
    btn.textContent=d.name;
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.difficulty-btn').forEach(el=>el.classList.remove('selected'));
      btn.classList.add('selected'); selectedDifficulty=d; rebuildStars(true); drawStart();
    });
    difficultySelect.appendChild(btn);
  });

  // ====== Game State ======
  const state = {
    running:false, paused:false, t:0, score:0, speed:2.2,
    spawnTimer:0, coinTimer:0,
    player:{x:0,y:0,w:44,h:44,vx:0, tilt:0, scale:1, shield:false},
    obstacles:[], coins:[], powerups:[],
    input:{left:false,right:false},
    effects:[], popups:[], recentPowerups:[]
  };

  // ====== Background: stars ======
  let starsFG=[], starsMG=[], starsBG=[];
  function rebuildStars(resetLayers){
    if(!resetLayers) return;
    const dens = selectedDifficulty.starDensity;
    function make(n){ const a=[]; for(let i=0;i<n;i++) a.push({x:Math.random()*W, y:Math.random()*H}); return a; }
    const countBG = Math.floor(W*H*dens/140);
    const countMG = Math.floor(W*H*dens/110);
    const countFG = Math.floor(W*H*dens/90);
    starsBG = make(countBG); starsMG = make(countMG); starsFG = make(countFG);
  }
  function drawSpace(){
    const g=ctx.createRadialGradient(W*0.7,H*0.2,Math.min(W,H)*0.1, W*0.5,H*0.8, Math.hypot(W,H)*0.6);
    g.addColorStop(0, selectedDifficulty.palette[1]);
    g.addColorStop(1, selectedDifficulty.palette[0]);
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#ffffff';
    for(const s of starsBG){ ctx.fillRect(s.x,s.y,1,1); s.y+=selectedDifficulty.parallax[0]; if(s.y>H) s.y=0; }
    for(const s of starsMG){ ctx.fillRect(s.x,s.y,2,2); s.y+=selectedDifficulty.parallax[1]; if(s.y>H) s.y=0; }
    for(const s of starsFG){ ctx.fillRect(s.x,s.y,3,3); s.y+=selectedDifficulty.parallax[2]; if(s.y>H) s.y=0; }
  }

  // ====== Drawing ======
  function drawPlayer(p){
    ctx.save();
    p.tilt += ((p.vx/7) - p.tilt)*0.1;
    const cx=p.x+p.w*0.5, cy=p.y+p.h*0.5;
    ctx.translate(cx,cy); ctx.rotate(p.tilt*0.25); ctx.scale(p.scale,p.scale); ctx.translate(-cx,-cy);
    const grad=ctx.createLinearGradient(p.x,p.y,p.x,p.y+p.h);
    grad.addColorStop(0, selectedShip.color1); grad.addColorStop(1, selectedShip.color2);
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.moveTo(p.x+p.w*0.5,p.y);
    ctx.lineTo(p.x+p.w*0.88,p.y+p.h*0.85);
    ctx.quadraticCurveTo(p.x+p.w*0.5,p.y+p.h*1.02,p.x+p.w*0.12,p.y+p.h*0.85);
    ctx.closePath(); ctx.fill();
    // cockpit
    ctx.fillStyle='rgba(173,216,230,0.65)';
    ctx.beginPath(); ctx.ellipse(p.x+p.w*0.5,p.y+p.h*0.42,p.w*0.18,p.h*0.16,0,0,Math.PI*2); ctx.fill();
    // shield ring
    if(p.shield){ ctx.strokeStyle='rgba(147,197,253,0.9)'; ctx.lineWidth=2; ctx.beginPath(); ctx.ellipse(cx,cy,p.w*0.65,p.h*0.7,0,0,Math.PI*2); ctx.stroke(); }
    ctx.restore();
  }
  function drawObstacle(o){
    ctx.save(); ctx.translate(o.x+o.w/2,o.y+o.h/2); ctx.rotate(o.rot);
    ctx.fillStyle='#94a3b8'; const x=-o.w/2,y=-o.h/2,r=6;
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+o.w,y,x+o.w,y+o.h,r);
    ctx.arcTo(x+o.w,y+o.h,x,y+o.h,r);
    ctx.arcTo(x,y+o.h,x,y,r);
    ctx.arcTo(x,y,x+o.w,y,r);
    ctx.closePath(); ctx.fill();
    ctx.restore();
  }
  function drawCoin(c){
    ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2);
    const g=ctx.createLinearGradient(c.x,c.y-c.r,c.x,c.y+c.r);
    g.addColorStop(0,'#fde68a'); g.addColorStop(1,'#fbbf24');
    ctx.fillStyle=g; ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,0.15)'; ctx.lineWidth=1; ctx.stroke();
  }
  function drawPowerup(p){
    ctx.font='20px ui-sans-serif, system-ui'; ctx.textAlign='center';
    ctx.fillText(p.type.icon, p.x, p.y);
  }
  function drawHUD(){
    ctx.fillStyle='#fff';
    ctx.font='600 16px ui-sans-serif, system-ui';
    ctx.textAlign='left';
    ctx.fillText(`Score: ${state.score}`,16,28);
  }
  function drawStart(){
    drawSpace();
    ctx.fillStyle='#fff'; ctx.textAlign='center';
    ctx.font='800 28px ui-sans-serif';
    ctx.fillText('Meteor Dash', W/2, H*0.38);
    ctx.font='500 16px ui-sans-serif';
    ctx.fillText('Pick a ship & difficulty, then press Start', W/2, H*0.46);
  }
  function drawGameOver(){
    drawSpace();
    ctx.fillStyle='#fff'; ctx.textAlign='center';
    ctx.font='800 46px ui-sans-serif';
    ctx.fillText('Game Over', W/2, H*0.40);
    ctx.font='600 18px ui-sans-serif';
    ctx.fillText(`Score: ${state.score}`, W/2, H*0.46);
  }

  // ====== Entities & helpers ======
  function rectsOverlap(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
  function circleRectOverlap(c,r){ const cx=Math.max(r.x,Math.min(c.x,r.x+r.w)); const cy=Math.max(r.y,Math.min(c.y,r.y+r.h)); const dx=c.x-cx, dy=c.y-cy; return (dx*dx+dy*dy) <= (c.r*c.r); }

  function spawnObstacle(){
    const w=28+Math.random()*42; const h=w*(0.8+Math.random()*0.3);
    const x=Math.random()*(W-w); const y=-h-10;
    const vy=state.speed + Math.random()*2.0 + state.t*0.0003;
    state.obstacles.push({x,y,w,h,vy, rot:Math.random()*Math.PI*2, vr:(Math.random()-0.5)*0.05});
  }
  function spawnCoin(){
    const r=10+Math.random()*4; const x=r+Math.random()*(W-r*2); const y=-r-10; const vy=state.speed+1;
    state.coins.push({x,y,r,vy});
  }

  // ====== Input ======
  addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') state.input.left=true;
    if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') state.input.right=true;
    if(e.key==='p'||e.key==='P') togglePause();
    if(e.key==='r'||e.key==='R') if(!state.running) start();
  });
  addEventListener('keyup', e=>{
    if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') state.input.left=false;
    if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') state.input.right=false;
  });
  document.querySelectorAll('.start').forEach(b=> b.addEventListener('click', ()=> btnStart.click() ));

  btnStart.addEventListener('click', ()=> start());
  btnPause.addEventListener('click', ()=> togglePause());

  function togglePause(){
    if(!state.running) return;
    state.paused = !state.paused;
    btnPause.textContent = state.paused? 'Resume' : 'Pause';
    if(!state.paused){ last=performance.now(); requestAnimationFrame(loop); }
  }

  function start(){
    try{
      // reset state
      state.running=true; state.paused=false; state.t=0; state.score=0;
      state.speed = selectedDifficulty.speed;
      state.spawnTimer=0; state.coinTimer=0;
      state.obstacles.length=0; state.coins.length=0;
      const pw=Math.max(30, Math.min(64, Math.floor(W*0.05)));
      state.player.w=pw; state.player.h=pw; state.player.scale=1; state.player.shield=false; state.player.vx=0; state.player.tilt=0;
      state.player.x=(W-pw)/2; state.player.y=H - pw*2.2;
      btnPause.disabled=false; btnStart.textContent='Restart';
      infobar.style.display='none';
      last=performance.now();
      if(!muted && bgMusic){ bgMusic.currentTime=0; tryPlayMusic(); }
      tone(700,0.08,'square',0.05);
      requestAnimationFrame(loop);
    }catch(e){ showErr("Start failed: " + e); }
  }

  // ====== Loop ======
  let last = 0;
  function loop(now){
    try{
      if(!state.running) return;
      if(state.paused) return;
      const dt=Math.min(33, now-last); last=now; state.t+=dt; state.speed += 0.00055*dt;

      // spawn
      state.spawnTimer -= dt; if(state.spawnTimer<=0){ state.spawnTimer=selectedDifficulty.spawn; spawnObstacle(); }
      state.coinTimer  -= dt; if(state.coinTimer<=0){ state.coinTimer=selectedDifficulty.coin; spawnCoin(); }

      // move
      const accel=0.0025*dt;
      if(state.input.left)  state.player.vx -= accel*dt;
      if(state.input.right) state.player.vx += accel*dt;
      state.player.vx *= 0.96;
      state.player.x += state.player.vx;
      state.player.x = Math.max(0, Math.min(W-state.player.w, state.player.x));

      for(const o of state.obstacles){ o.y+=o.vy; o.rot+=o.vr; }
      for(const c of state.coins) c.y+=c.vy;

      // cull
      state.obstacles = state.obstacles.filter(o=>o.y < H+60);
      state.coins     = state.coins.filter(c=>c.y < H+60);

      // collisions
      for(const o of state.obstacles){ if(rectsOverlap(state.player,o)){ gameOver(); return; } }
      for(let i=state.coins.length-1;i>=0;i--){
        const c=state.coins[i];
        if(circleRectOverlap(c,state.player)){
          state.coins.splice(i,1); state.score += Math.round(25*selectedDifficulty.multiplier);
          tone(1000,0.08,'triangle',0.06);
        }
      }

      // score tick
      state.score += Math.floor(0.02*dt*selectedDifficulty.multiplier);
      if(state.score>hi){ hi=state.score; try{ localStorage.setItem('meteorDash_hi', String(hi)); }catch(_){} elHi.textContent=`Best: ${hi}`; }

      // render
      drawSpace();
      drawHUD();
      for(const o of state.obstacles) drawObstacle(o);
      for(const c of state.coins) drawCoin(c);
      drawPlayer(state.player);

      elScore.textContent = `Score: ${state.score}`;
      requestAnimationFrame(loop);
    }catch(e){ showErr("Loop crashed: " + e + (e && e.stack ? "\n" + e.stack : "")); }
  }

  function gameOver(){
    tone(160,0.25,'square',0.09);
    state.running=false; btnPause.disabled=true;
    drawGameOver();
    infobar.style.display='flex';
    infobar.querySelector('.card').firstChild;
  }

  // init
  rebuildStars(true);
  drawStart();
})();
</script>
</body>
</html>

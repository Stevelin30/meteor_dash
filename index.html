<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Meteor Dash ‚Äî Final Build (Brand + Touch + Overlay Loop)</title>
<style>
  :root{ --bg:#0b1020; --fg:#e2e8f0; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:ui-sans-serif,system-ui; }
  #wrap{ position:fixed; inset:0; display:flex; flex-direction:column; }
  header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.08); }
  .controls,.right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  button{ cursor:pointer; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--fg); font-weight:700; }
  #canvas{ flex:1 1 auto; width:100%; height:100%; display:block; background:#0b1020; }
  footer{ display:flex; justify-content:center; padding:8px; font-size:12px; opacity:.9; gap:12px; flex-wrap:wrap; }
  #shipSelect{ display:flex; gap:8px; }
  .ship-option{ width:28px; height:28px; border-radius:6px; cursor:pointer; border:2px solid transparent; }
  .ship-option.selected{ border-color:white; }
  #difficultySelect{ display:flex; gap:6px; }
  .difficulty-btn{ padding:4px 8px; border-radius:6px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:white; font-weight:700; }
  .volwrap{ display:flex; align-items:center; gap:6px; }
  #musicVolume{ width:110px; }
  #err{ position:fixed; left:12px; right:12px; bottom:12px; z-index:9999; background:#7f1d1d; color:#fff; padding:12px; border:2px solid #fecaca; border-radius:10px; font-family:ui-monospace,monospace; display:none; white-space:pre-wrap }

  /* Title overlay */
  #titleOverlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background: radial-gradient(ellipse at 50% 40%, rgba(255,255,255,.05), rgba(0,0,0,.6));
    z-index:15;
  }
  #titleOverlay .card{
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    padding:24px 28px; border-radius:16px; text-align:center; backdrop-filter:blur(2px);
  }
  #titleOverlay h1{ margin:0 0 8px; font-size:32px; font-weight:900; }
  #titleOverlay p{ margin:0 0 14px; opacity:.9; }
  #bigStart{ font-size:18px; font-weight:800; padding:8px 16px; }

  /* Touch controls */
  #touchControls{
    position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
    display:none; gap:16px; z-index:20;
  }
  #touchControls button{
    width:64px; height:64px; border-radius:9999px;
    background:rgba(255,255,255,.08); border:2px solid rgba(255,255,255,.2);
    color:#fff; font-size:26px; font-weight:800;
  }
  #touchControls button:active{ transform:scale(0.97); }
  @media (pointer: coarse){
    #touchControls{ display:flex; }
    header .controls > span { display:none; }
  }
</style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="controls">
      <span id="scoreLabel">Score: 0</span>
      <span id="hiLabel">Best: 0</span>
      <button id="btnStart">Start</button>
      <button id="btnPause" disabled>Pause</button>
      <button id="btnMute" aria-pressed="false">üîä</button>
      <div class="volwrap">
        <input id="musicVolume" type="range" min="0" max="1" step="0.05" value="0.4" />
        <span id="volLabel" style="display:inline-block; width:40px; text-align:right;">40%</span>
      </div>
    </div>
    <div class="right">
      <div id="shipSelect" title="Pick a ship"></div>
      <div id="difficultySelect" title="Difficulty"></div>
    </div>
  </header>

  <canvas id="canvas"></canvas>

  <footer>
    <span>¬© stevelin30 productions ¬∑ v1.0</span>
    <span>Move: ‚Üê ‚Üí or A/D</span>
    <span>Pause: P ¬∑ Restart: R</span>
  </footer>
</div>

<!-- Title overlay -->
<div id="titleOverlay">
  <div class="card">
    <h1>stevelin30 productions <span style='font-size:16px;font-weight:600;opacity:.8'>(v1.0)</span></h1>
    <p>Meteor Dash ‚Äî Outrun the debris. Grab coins. Try not to explode.</p>
    <p><em>How to Play: Use ‚Üê ‚Üí (A/D) or touch buttons to move. Collect coins, dodge meteors!</em></p>
    <button id="bigStart">Start</button>
  </div>
</div>

<!-- Touch controls -->
<div id="touchControls">
  <button id="btnLeft" aria-label="Move Left">‚óÄ</button>
  <button id="btnRight" aria-label="Move Right">‚ñ∂</button>
</div>

<audio id="bgMusic" loop preload="auto">
  <source src="music.mp3" type="audio/mpeg" />
</audio>
<div id="err"></div>

<script>
(function(){
  // ===== Error overlay =====
  const errBox = document.getElementById('err');
  function showErr(msg){ errBox.style.display='block'; errBox.textContent=msg; console.error(msg); }
  window.onerror = (m,src,l,c,e)=> showErr(`JS Error: ${m}\n${src}:${l}:${c}${e&&e.stack?'\n'+e.stack:''}`);
  window.addEventListener('unhandledrejection', e=> showErr('Promise rejection: '+e.reason));

  // ===== Canvas & sizing =====
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  let W=0, H=0;

  // Default difficulty to avoid early-access crash
  let selectedDifficulty = { name:'Normal', speed:2.3, spawn:400, coin:900, multiplier:1.0, starDensity:0.22, palette:['#0b1020','#12183b'], parallax:[0.15,0.35,0.7] };

  function resize(){
    try{
      const hH = document.querySelector('header').offsetHeight||0;
      const fH = document.querySelector('footer').offsetHeight||0;
      W = Math.floor(window.innerWidth);
      H = Math.floor(window.innerHeight - hH - fH);
      if(H<120) H=120;
      canvas.width = Math.floor(W*DPR);
      canvas.height = Math.floor(H*DPR);
      canvas.style.width = W+'px';
      canvas.style.height = H+'px';
      ctx.setTransform(DPR,0,0,DPR,0,0);
      drawStart();
    }catch(e){ showErr('Resize failed: '+e); }
  }
  addEventListener('resize', resize, {passive:true});

  // ===== UI =====
  const elScore = document.getElementById('scoreLabel');
  const elHi = document.getElementById('hiLabel');
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnMute = document.getElementById('btnMute');
  const volSlider = document.getElementById('musicVolume');
  const volLabel = document.getElementById('volLabel');
  const shipSelect = document.getElementById('shipSelect');
  const difficultySelect = document.getElementById('difficultySelect');

  const titleOverlay = document.getElementById('titleOverlay');
  const bigStart = document.getElementById('bigStart');
  const btnLeft = document.getElementById('btnLeft');
  const btnRight = document.getElementById('btnRight');

  let hi = 0; try{ hi = Number(localStorage.getItem('meteorDash_hi')||0); }catch(_){ }
  elHi.textContent = `Best: ${hi}`;

  // ===== Text helpers (bold + outline) =====
  function setBoldFont(size=16, weight=800){ return `${weight} ${size}px ui-sans-serif,system-ui`; }
  function drawTextOutlined(ctx, text, x, y, {
    size = 16, weight = 800, align = 'left', baseline = 'alphabetic',
    fill = '#ffffff', outline = 'rgba(0,0,0,0.85)', outlineWidth = 4
  } = {}){
    ctx.save();
    ctx.font = setBoldFont(size, weight);
    ctx.textAlign = align; ctx.textBaseline = baseline;
    ctx.lineJoin = 'round'; ctx.miterLimit = 2;
    ctx.strokeStyle = outline; ctx.lineWidth = outlineWidth; ctx.strokeText(text, x, y);
    ctx.fillStyle = fill; ctx.fillText(text, x, y);
    ctx.restore();
  }

  // ===== Audio (looping + fade) =====
  const bgMusic = document.getElementById('bgMusic');
  const AudioCtx = window.AudioContext||window.webkitAudioContext;
  let ac = null, muted = false, masterVolume = parseFloat(volSlider.value)||0.4;
  let musicSource = null, musicGain = null;

  function ensureAudio(){ if(!ac) ac = new AudioCtx(); }
  function ensureMusicGraph(){
    try{
      ensureAudio(); if(!bgMusic) return;
      if(!musicSource){
        musicSource = ac.createMediaElementSource(bgMusic);
        musicGain = ac.createGain(); musicGain.gain.value = masterVolume;
        musicSource.connect(musicGain); musicGain.connect(ac.destination);
        bgMusic.volume = 1.0; // WebAudio handles fades
      }
    }catch(e){ /* ignore double-connect */ }
  }
  function setVolume(v){
    masterVolume = Math.max(0, Math.min(1, v));
    if(musicGain){ musicGain.gain.value = masterVolume; }
    else if(bgMusic){ bgMusic.volume = masterVolume; }
    volSlider.value = String(masterVolume);
    volLabel.textContent = Math.round(masterVolume*100)+'%';
  }
  setVolume(masterVolume);
  volSlider.addEventListener('input', e=> setVolume(parseFloat(e.target.value)||masterVolume));

  async function tryPlayMusic(){
    if(!bgMusic) return;
    try{ ensureAudio(); ensureMusicGraph(); await bgMusic.play(); }
    catch(e){ /* gesture may be needed */ }
  }
  function fadeMusic(to=1, ms=250){
    if(musicGain && ac){
      const now = ac.currentTime; const current = musicGain.gain.value; const target = Math.max(0,to)*masterVolume;
      musicGain.gain.setValueAtTime(current, now);
      musicGain.gain.linearRampToValueAtTime(target, now + ms/1000);
    }else if(bgMusic){
      const start = bgMusic.volume; const target = Math.max(0,to);
      const steps = 12; const step=(target-start)/steps; let i=0;
      const id=setInterval(()=>{ i++; bgMusic.volume=Math.max(0,Math.min(1,start+step*i)); if(i>=steps) clearInterval(id); }, Math.max(16, ms/steps));
    }
  }
  function tone(freq=880, dur=0.09, type='sine', vol=0.05){
    if(muted) return;
    try{ ensureAudio(); const o=ac.createOscillator(), g=ac.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol*masterVolume; o.connect(g); g.connect(ac.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+dur); o.stop(ac.currentTime+dur); }
    catch(e){ showErr('Audio error: '+e); }
  }
  btnMute.addEventListener('click', ()=>{
    muted = !muted; btnMute.textContent = muted ? 'üîá' : 'üîä'; btnMute.setAttribute('aria-pressed', String(muted));
    if(bgMusic){ if(muted){ fadeMusic(0,250); setTimeout(()=>bgMusic.pause(),260); } else { tryPlayMusic(); fadeMusic(1,250); } }
  });
  ;['click','keydown','touchstart'].forEach(evt=>{
    window.addEventListener(evt, async ()=>{
      try{ ensureAudio(); if(ac.state==='suspended') await ac.resume(); ensureMusicGraph(); if(!muted && bgMusic && bgMusic.paused){ await bgMusic.play(); fadeMusic(1,200); } }catch(_){ }
    }, {once:true, passive:true});
  });

  // ===== Ships & Difficulty =====
  const ships = [
    {name:'Red',   color1:'#f87171', color2:'#ef4444'},
    {name:'Blue',  color1:'#60a5fa', color2:'#2563eb'},
    {name:'Green', color1:'#34d399', color2:'#059669'},
    {name:'Purple',color1:'#c084fc', color2:'#7c3aed'}
  ];
  let selectedShip = ships[0];
  ships.forEach((s,i)=>{
    const d=document.createElement('div');
    d.className='ship-option'+(i===0?' selected':'');
    d.style.background=`linear-gradient(${s.color1},${s.color2})`;
    d.title=s.name;
    d.addEventListener('click', ()=>{
      document.querySelectorAll('.ship-option').forEach(el=>el.classList.remove('selected'));
      d.classList.add('selected'); selectedShip=s; drawStart();
    });
    shipSelect.appendChild(d);
  });

  const difficulties = [
    {name:'Easy',   speed:1.6, spawn:520, coin:650, multiplier:1.0, starDensity:0.18, palette:['#0b1020','#0e1633'], parallax:[0.1,0.25,0.5]},
    {name:'Normal', speed:2.3, spawn:400, coin:900, multiplier:1.0, starDensity:0.22, palette:['#0b1020','#12183b'], parallax:[0.15,0.35,0.7]},
    {name:'Hard',   speed:3.1, spawn:300, coin:1250, multiplier:1.2, starDensity:0.26, palette:['#0a0c24','#0f1640'], parallax:[0.2,0.5,0.9]},
    {name:'Insane', speed:4.2, spawn:200, coin:2100, multiplier:1.5, starDensity:0.32, palette:['#120a20','#2a0e3c'], parallax:[0.28,0.7,1.2]}
  ];
  selectedDifficulty = difficulties[1];
  difficulties.forEach((d,i)=>{
    const b=document.createElement('button'); b.className='difficulty-btn'+(i===1?' selected':''); b.textContent=d.name;
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.difficulty-btn').forEach(el=>el.classList.remove('selected'));
      b.classList.add('selected'); selectedDifficulty=d; rebuildStars(true); drawStart();
    });
    difficultySelect.appendChild(b);
  });

  // ===== Comedic Game Over lines =====
  const funnyDeaths = [
    "Oops‚Ä¶ your insurance premium just skyrocketed!",
    "Houston, we have a YOU problem.",
    "That‚Äôll buff right out. Probably.",
    "Your ship‚Äôs warranty does not cover meteor damage.",
    "Well, that escalated quickly.",
    "Looks like you‚Äôve joined the space debris club.",
    "Next time, try steering!",
    "Meteor 1, You 0.",
    "The galaxy says: better luck next run!"
  ];

  // ===== Game State =====
  const state = {
    running:false, paused:false, t:0, score:0, speed:selectedDifficulty.speed,
    spawnTimer:0, coinTimer:0,
    player:{x:0,y:0,w:44,h:44,vx:0, tilt:0, scale:1, shield:false},
    obstacles:[], coins:[],
    input:{left:false,right:false}
  };

  // ===== Background stars =====
  let starsFG=[], starsMG=[], starsBG=[];
  function rebuildStars(reset){
    if(!reset) return;
    const dens=selectedDifficulty.starDensity;
    function make(n){ const a=[]; for(let i=0;i<n;i++) a.push({x:Math.random()*W,y:Math.random()*H}); return a; }
    const nBG=Math.floor(W*H*dens/140), nMG=Math.floor(W*H*dens/110), nFG=Math.floor(W*H*dens/90);
    starsBG=make(nBG); starsMG=make(nMG); starsFG=make(nFG);
  }
  function drawSpace(){
    const g=ctx.createRadialGradient(W*0.7,H*0.2,Math.min(W,H)*0.1, W*0.5,H*0.8, Math.hypot(W,H)*0.6);
    g.addColorStop(0, selectedDifficulty.palette[1]); g.addColorStop(1, selectedDifficulty.palette[0]);
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#fff';
    for(const s of starsBG){ ctx.fillRect(s.x,s.y,1,1); s.y+=selectedDifficulty.parallax[0]; if(s.y>H) s.y=0; }
    for(const s of starsMG){ ctx.fillRect(s.x,s.y,2,2); s.y+=selectedDifficulty.parallax[1]; if(s.y>H) s.y=0; }
    for(const s of starsFG){ ctx.fillRect(s.x,s.y,3,3); s.y+=selectedDifficulty.parallax[2]; if(s.y>H) s.y=0; }
  }

  // ===== Draw entities =====
  function drawPlayer(p){
    ctx.save();
    p.tilt += ((p.vx/7)-p.tilt)*0.1;
    const cx=p.x+p.w*0.5, cy=p.y+p.h*0.5;
    ctx.translate(cx,cy); ctx.rotate(p.tilt*0.25); ctx.scale(p.scale,p.scale); ctx.translate(-cx,-cy);
    const grad=ctx.createLinearGradient(p.x,p.y,p.x,p.y+p.h); grad.addColorStop(0,selectedShip.color1); grad.addColorStop(1,selectedShip.color2);
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.moveTo(p.x+p.w*0.5,p.y);
    ctx.lineTo(p.x+p.w*0.88,p.y+p.h*0.85);
    ctx.quadraticCurveTo(p.x+p.w*0.5,p.y+p.h*1.02,p.x+p.w*0.12,p.y+p.h*0.85);
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='rgba(173,216,230,0.65)';
    ctx.beginPath(); ctx.ellipse(p.x+p.w*0.5,p.y+p.h*0.42,p.w*0.18,p.h*0.16,0,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  function drawObstacle(o){
    ctx.save(); ctx.translate(o.x+o.w/2,o.y+o.h/2); ctx.rotate(o.rot||0);
    ctx.fillStyle='#94a3b8'; const x=-o.w/2,y=-o.h/2,r=6;
    ctx.beginPath(); ctx.moveTo(x+r,y);
    ctx.arcTo(x+o.w,y,x+o.w,y+o.h,r);
    ctx.arcTo(x+o.w,y+o.h,x,y+o.h,r);
    ctx.arcTo(x,y+o.h,x,y,r);
    ctx.arcTo(x,y,x+o.w,y,r); ctx.closePath(); ctx.fill();
    ctx.restore();
  }
  function drawCoin(c){
    ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2);
    const g=ctx.createLinearGradient(c.x,c.y-c.r,c.x,c.y+c.r); g.addColorStop(0,'#fde68a'); g.addColorStop(1,'#fbbf24');
    ctx.fillStyle=g; ctx.fill(); ctx.strokeStyle='rgba(0,0,0,0.15)'; ctx.lineWidth=1; ctx.stroke();
  }

  // ===== UI text =====
  function drawHUD(){ drawTextOutlined(ctx, `Score: ${state.score}`, 16, 28, { size: 16, weight: 800, align:'left' }); }
  function drawStart(){ drawSpace(); drawTextOutlined(ctx, 'Meteor Dash', W/2, H*0.38, { size: 28, weight: 800, align:'center' }); drawTextOutlined(ctx, 'Pick a ship & difficulty, then press Start', W/2, H*0.46, { size: 16, weight: 700, align:'center' }); }
  function drawGameOverWithMsg(msg){ drawSpace(); drawTextOutlined(ctx, 'Game Over', W/2, H*0.40, { size: 46, weight: 800, align:'center' }); drawTextOutlined(ctx, `Score: ${state.score}`, W/2, H*0.46, { size: 18, weight: 700, align:'center' }); if(msg){ drawTextOutlined(ctx, msg, W/2, H*0.54, { size: 16, weight: 700, align:'center' }); }
    drawTextOutlined(ctx, 'Press R or tap Start to Restart', W/2, H*0.62, { size: 14, weight: 600, align:'center' });
    drawTextOutlined(ctx, 'Press R or tap Start to Restart', W/2, H*0.62, { size: 14, weight: 600, align:'center' }); }

  // ===== Helpers =====
  function rectsOverlap(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
  function circleRectOverlap(c,r){ const cx=Math.max(r.x,Math.min(c.x,r.x+r.w)); const cy=Math.max(r.y,Math.min(c.y,r.y+r.h)); const dx=c.x-cx, dy=c.y-cy; return (dx*dx+dy*dy) <= (c.r*c.r); }

  // ===== Spawning =====
  function spawnObstacle(){ const w=28+Math.random()*42, h=w*(0.8+Math.random()*0.3); const x=Math.random()*(W-w), y=-h-10, vy=state.speed + Math.random()*2.0 + state.t*0.0003; state.obstacles.push({x,y,w,h,vy, rot:Math.random()*Math.PI*2, vr:(Math.random()-0.5)*0.05}); }
  function spawnCoin(){ const r=10+Math.random()*4, x=r+Math.random()*(W-r*2), y=-r-10, vy=state.speed+1; state.coins.push({x,y,r,vy}); }

  // ===== Input =====
  addEventListener('keydown', e=>{ if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') state.input.left=true; if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') state.input.right=true; if(e.key==='p'||e.key==='P') togglePause(); if(e.key==='r'||e.key==='R') if(!state.running) start(); });
  addEventListener('keyup', e=>{ if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') state.input.left=false; if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') state.input.right=false; });

  function bindHold(btn, onDown, onUp){ const down=e=>{ e.preventDefault(); onDown(); }; const up=e=>{ e.preventDefault(); onUp(); }; if(!btn) return; btn.addEventListener('touchstart', down, {passive:false}); btn.addEventListener('touchend', up); btn.addEventListener('touchcancel', up); btn.addEventListener('mousedown', down); window.addEventListener('mouseup', up); }
  bindHold(document.getElementById('btnLeft'),  ()=> state.input.left  = true, ()=> state.input.left  = false);
  bindHold(document.getElementById('btnRight'), ()=> state.input.right = true, ()=> state.input.right = false);
  window.addEventListener('touchmove', (e)=>{ if (e.target.closest && e.target.closest('#touchControls')) e.preventDefault(); }, {passive:false});

  btnPause.addEventListener('click', ()=> togglePause());
  function togglePause(){ if(!state.running) return; state.paused = !state.paused; btnPause.textContent = state.paused ? 'Resume' : 'Pause'; if(!state.paused){ last=performance.now(); requestAnimationFrame(loop); } }

  btnStart.addEventListener('click', start);
  if (bigStart) bigStart.addEventListener('click', ()=> btnStart.click());

  async function start(){
    // reset state
    state.running=true; state.paused=false; state.t=0; state.score=0;
    state.speed = selectedDifficulty.speed; state.spawnTimer=0; state.coinTimer=0;
    state.obstacles.length=0; state.coins.length=0;
    const pw=Math.max(30, Math.min(64, Math.floor(W*0.05)));
    state.player.w=pw; state.player.h=pw; state.player.scale=1; state.player.vx=0; state.player.tilt=0;
    state.player.x=(W-pw)/2; state.player.y=H - pw*2.2;
    btnPause.disabled=false; btnStart.textContent='Restart';
    if (titleOverlay) titleOverlay.style.display='none';

    // Start/resume music without restarting if already playing
    try{ ensureAudio(); if(ac.state==='suspended') await ac.resume(); ensureMusicGraph(); }catch(_){ }
    if(!muted && bgMusic){ if(bgMusic.paused){ tryPlayMusic(); fadeMusic(1,250); } }

    last=performance.now(); tone(700,0.08,'square',0.05); requestAnimationFrame(loop);
  }

  // ===== Loop =====
  let last = 0;
  function loop(now){
    if(!state.running || state.paused) return;
    const dt=Math.min(33, now-last); last=now; state.t+=dt; state.speed += 0.00055*dt;

    // spawn
    state.spawnTimer -= dt; if(state.spawnTimer<=0){ state.spawnTimer=selectedDifficulty.spawn; spawnObstacle(); }
    state.coinTimer  -= dt; if(state.coinTimer<=0){ state.coinTimer=selectedDifficulty.coin; spawnCoin(); }

    // move
    const accel=0.0025*dt; if(state.input.left) state.player.vx -= accel*dt; if(state.input.right) state.player.vx += accel*dt; state.player.vx *= 0.96; state.player.x = Math.max(0, Math.min(W-state.player.w, state.player.x + state.player.vx));
    for(const o of state.obstacles){ o.y+=o.vy; o.rot+=o.vr; }
    for(const c of state.coins) c.y+=c.vy;

    // cull
    state.obstacles = state.obstacles.filter(o=>o.y < H+60);
    state.coins     = state.coins.filter(c=>c.y < H+60);

    // collisions
    for(const o of state.obstacles){ if(rectsOverlap(state.player,o)){ gameOver(); return; } }
    for(let i=state.coins.length-1;i>=0;i--){ const c=state.coins[i]; if(circleRectOverlap(c,state.player)){ state.coins.splice(i,1); state.score += Math.round(25*selectedDifficulty.multiplier); tone(1000,0.08,'triangle',0.06); } }

    // score tick
    state.score += Math.floor(0.02*dt*selectedDifficulty.multiplier);
    if(state.score>hi){ hi=state.score; try{ localStorage.setItem('meteorDash_hi', String(hi)); }catch(_){ } elHi.textContent = `Best: ${hi}`; }

    // render
    drawSpace(); drawHUD();
    for(const o of state.obstacles) drawObstacle(o);
    for(const c of state.coins) drawCoin(c);
    drawPlayer(state.player);

    elScore.textContent = `Score: ${state.score}`;
    requestAnimationFrame(loop);
  }

  function gameOver(){
    tone(160,0.25,'square',0.09);
    state.running=false; btnPause.disabled=true;
    const msg = funnyDeaths[Math.floor(Math.random()*funnyDeaths.length)];
    drawGameOverWithMsg(msg);
    // Bring back title overlay with Restart label
    if (titleOverlay){ titleOverlay.style.display='flex'; const tbtn=document.getElementById('bigStart'); if(tbtn) tbtn.textContent='Restart'; }
  }

  // Kick off
  resize();
  (function init(){
    // difficulties setup must happen after default exists
    const buttons = difficultySelect.querySelectorAll('button');
    if(!buttons.length){ /* already created above */ }
    rebuildStars(true); drawStart();
  })();

  // Diagnostics (console)
  bgMusic?.addEventListener('canplaythrough', ()=> console.log('Music ready:', bgMusic.currentSrc));
  bgMusic?.addEventListener('error', ()=> console.warn('Music failed to load. Ensure music.mp3 sits next to index.html (case-sensitive).'));
})();
</script>
</body>
</html>
